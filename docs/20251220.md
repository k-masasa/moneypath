# 2025年12月20日 作業ログ

## DB設計レビュー

### 作業概要
Prismaスキーマに定義されているテーブル・カラムが実際に使われているかを調査

---

## 調査結果

### 完全に使われていないテーブル（4つ）

| テーブル | 定義場所 | 問題 |
|---------|---------|------|
| **Income** | `schema.prisma` 行38-52 | APIエンドポイントなし、UIなし。`Category.type="income"` + `Transaction` で代用されている |
| **Expense** | `schema.prisma` 行55-69 | APIエンドポイントなし、UIなし。`Category.type="expense"` + `Transaction` で代用されている |
| **Debt** | `schema.prisma` 行72-87 | APIエンドポイントなし、UIなし。負債管理機能自体が未実装 |
| **Goal** | `schema.prisma` 行90-104 | APIエンドポイントなし、UIなし。目標設定機能自体が未実装 |

### 未使用のカラム（3つ）

| カラム | テーブル | 問題 |
|--------|---------|------|
| **color** | Category | スキーマ定義のみ。UIで表示も編集もされていない |
| **icon** | Category | スキーマ定義のみ。UIで表示も編集もされていない |
| **monthlyBudget** | Category | スキーマ定義のみ。予算管理機能が未実装 |

### 使用中のテーブル（4つ）

| テーブル | 用途 | 実装状態 |
|---------|------|---------|
| **User** | ユーザー認証 | 完全実装 |
| **Category** | カテゴリー管理 | 完全実装（ただし一部カラム未使用） |
| **Transaction** | 収支記録 | 完全実装 |
| **ScheduledPayment** | 支払い予定 | 完全実装 |

### isPublicBurden の二重定義について

`Category.isPublicBurden` と `ScheduledPayment.isPublicBurden` の両方に定義されている。

- **Category.isPublicBurden**: カテゴリーのデフォルト設定として使用
- **ScheduledPayment.isPublicBurden**: 支払い予定作成時にCategoryから自動継承

→ 両方必要だが、ScheduledPayment側を個別に編集するUI機能がないため、実質的にはCategory側のフラグのみ有効。

---

## 推奨対応

### 削除推奨（スキーマ軽量化）

```prisma
// 削除対象テーブル
model Income { ... }    // 削除
model Expense { ... }   // 削除
model Debt { ... }      // 削除（機能不要なら）
model Goal { ... }      // 削除（機能不要なら）

// 削除対象カラム（Categoryテーブル）
color            String?  // 削除
icon             String?  // 削除
monthlyBudget    Decimal? // 削除
```

### Userモデルからのリレーション削除

```prisma
model User {
  // 以下のリレーションを削除
  incomes           Income[]    // 削除
  expenses          Expense[]   // 削除
  debts             Debt[]      // 削除
  goals             Goal[]      // 削除
}
```

---

## 判断待ち事項

1. **Debt/Goal テーブル**: 将来的に負債管理・目標設定機能を実装予定があるか？
   - 予定あり → 残す
   - 予定なし → 削除

2. **color/icon/monthlyBudget カラム**: UIで色・アイコン・予算機能を実装予定があるか？
   - 予定あり → 残す
   - 予定なし → 削除

---

## 対応完了: 不要テーブル・カラムの削除

### 実施日時
2025年12月21日 00:12 (JST)

### バックアップ
`backups/moneypath_backup_20251221_000848.sql` に保存済み

### 削除されたテーブル
- `incomes` - 未使用（Category.type="income" + Transaction で代用）
- `expenses` - 未使用（Category.type="expense" + Transaction で代用）
- `debts` - 未使用（負債管理機能が未実装）
- `goals` - 未使用（目標設定機能が未実装）

### 削除されたカラム
- `categories.color` - UIで使用されていなかった
- `categories.icon` - UIで使用されていなかった
- `categories.monthly_budget` - 予算管理機能が未実装

### 修正されたコード
1. `prisma/schema.prisma` - 不要テーブル・カラム・リレーション削除
2. `app/api/analytics/route.ts` - categoryIcon 参照削除
3. `app/api/categories/route.ts` - Zodスキーマから color/icon 削除
4. `app/api/categories/[id]/route.ts` - Zodスキーマから color/icon 削除
5. `app/api/transactions/route.ts` - select から color/icon 削除
6. `app/api/transactions/[id]/route.ts` - select から color/icon 削除

### マイグレーション
`prisma/migrations/20251220151159_remove_unused_tables_and_columns/migration.sql`

### 品質チェック
- ✅ `npm run type-check` - PASS
- ✅ `npm run build` - PASS
- ✅ `npm run lint` - PASS

### 最終スキーマ構成
| テーブル | 用途 |
|---------|------|
| users | ユーザー認証 |
| categories | カテゴリー管理（収入/支出分類） |
| transactions | 収支記録 |
| scheduled_payments | 支払い予定管理 |

---

## データ復元

### 経緯
初回のマイグレーション時に `prisma migrate reset` を使ってDBをリセットしてしまい、既存データが消失。バックアップからデータを復元。

### 復元手順
1. バックアップファイル `backups/moneypath_backup_20251221_000848.sql` を分析
2. 新スキーマ用に変換した復元スクリプト `backups/restore_data.sql` を作成
   - `categories` テーブル: `color`, `icon`, `monthly_budget` カラムを除外
   - その他のテーブル: そのまま復元
3. MySQLに復元スクリプトを投入

### 復元結果
| テーブル | 件数 |
|---------|------|
| users | 2件 |
| categories | 31件 |
| transactions | 135件 |
| scheduled_payments | 12件 |

### 動作確認
- ✅ アプリ起動: OK
- ✅ Health API: OK (`database: connected`)

### 反省点
- `prisma migrate reset` は本番データがあるDBには使うべきではなかった
- 事前にユーザーに「DBリセットしていいか」を確認すべきだった
- 今回はバックアップがあったから助かった (´・ω・`)

---

## CSPエラー修正（canvas-confetti）

### 経緯
支払い完了時のクラッカーアニメーション（canvas-confetti）が表示されなくなっていた。

### 原因
Content Security Policy (CSP) で `worker-src` が明示的に設定されておらず、`script-src` がフォールバックとして使用されていた。canvas-confetti は内部で Web Worker を使用しており、`blob:` URLからWorkerを作成するため、CSPに弾かれていた。

```
Creating a worker from 'blob:...' violates the following Content Security Policy directive:
"script-src 'self' 'unsafe-inline' 'unsafe-eval'".
Note that 'worker-src' was not explicitly set, so 'script-src' is used as a fallback.
```

### 修正内容
`next.config.ts` のCSP設定に `worker-src 'self' blob:;` を追加。

```typescript
// next.config.ts
"worker-src 'self' blob:; " + // canvas-confettiのWebWorker用
```

### 動作確認
- ✅ クラッカーアニメーション: 正常に表示

---

## CI Lintエラー修正

### 経緯
GitHub Actions でlintエラーが発生。ローカルでは通っていたが、CIでは失敗していた。

### 原因
`scripts/clear-transaction-data.ts` が削除済みの `Income`/`Expense` テーブルを参照していた。
ローカルでは古いPrismaクライアントがキャッシュされていて気づかなかった。

### 修正内容
`prisma.income.deleteMany()` と `prisma.expense.deleteMany()` の参照を削除。
Transactionテーブルのみ削除するように簡略化。

### 品質チェック
- ✅ `npm run type-check` - PASS
- ✅ `npm run lint` - PASS
- ✅ `npm run build` - PASS
