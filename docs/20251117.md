# 2025/11/17 作業ログ

## 実装内容

### 1. 支払い予定機能の実装

#### 目的

これから支払わなければならないお金（健康保険、年金、住民税、家賃など）を登録し、支払った時点で画面操作して今日の日付で支出として登録できるようにする。

#### 要件

- 支払い予定の手動登録（自動繰り返しではない）
- 支払い時に実際の金額を入力（予定額は参考値）
- /transactionsページに表示
- 通知機能は不要

#### データベース設計

- `ScheduledPayment`モデルを追加
  - `name`: 支払い名（例：健康保険、家賃）
  - `categoryId`: カテゴリーID（支出カテゴリー）
  - `estimatedAmount`: 予定金額
  - `dueDate`: 支払い期限
  - `status`: ステータス（pending/completed）
  - `transactionId`: 紐付けられたトランザクションID（支払い完了時）
  - `completedAt`: 完了日時

#### 実装手順

1. ✅ Prismaスキーマ更新（ScheduledPaymentモデル追加）
2. ✅ DB変更適用（npx prisma db push）
3. ✅ scheduled-payments API実装（POST, GET）
4. ✅ scheduled-payments/[id]/complete API実装
5. ✅ scheduled-payments/[id] DELETE API実装
6. ✅ 支払い完了ダイアログコンポーネント作成
7. ✅ 支払い予定リストコンポーネント作成
8. ✅ transactionsページに統合
9. ✅ type-check実行
10. ✅ build実行
11. 🚧 動作確認（ユーザー確認待ち）

#### API仕様

**POST /api/scheduled-payments**

```typescript
Request: {
  name: string;
  categoryId: string;
  estimatedAmount: number;
  dueDate: string; // ISO date
}
Response: {
  scheduledPayment: ScheduledPayment;
}
```

**GET /api/scheduled-payments**

```typescript
Response: {
  scheduledPayments: ScheduledPayment[];
}
```

**PUT /api/scheduled-payments/[id]/complete**

```typescript
Request: {
  actualAmount: number;
}
Response: {
  scheduledPayment: ScheduledPayment;
  transaction: Transaction;
}
```

**DELETE /api/scheduled-payments/[id]**

```typescript
Response: {
  success: boolean;
}
```

#### 実装したファイル

**API層**

- `app/api/scheduled-payments/route.ts` - POST（作成）, GET（一覧取得）
- `app/api/scheduled-payments/[id]/route.ts` - DELETE（削除）
- `app/api/scheduled-payments/[id]/complete/route.ts` - PUT（支払い完了）

**コンポーネント層**

- `components/scheduled-payments-list.tsx` - 支払い予定リスト表示コンポーネント
- `components/complete-payment-dialog.tsx` - 支払い完了ダイアログ

**ページ層**

- `app/transactions/page.tsx` - 支払い予定機能を統合

#### 発生した問題と解決策

**問題1: TypeScript型エラー（Category.type）**

- **エラー内容**: `Type 'string' is not assignable to type '"income" | "expense"'`
- **原因**: `scheduled-payments-list.tsx`のCategory型定義で`type: string`としていたが、transactionsページでは`type: "income" | "expense"`と定義されていた
- **解決策**: `scheduled-payments-list.tsx`のCategory型を修正して`type: "income" | "expense"`に統一

**問題2: Next.js 16でのparamsの扱い（ビルドエラー）**

- **エラー内容**: `Property 'id' is missing in type 'Promise<{ id: string; }>' but required in type '{ id: string; }'`
- **原因**: Next.js 16では動的ルートのparamsがPromise型になったが、コードでは同期的に扱っていた
- **解決策**:
  - paramsの型を`{ params: { id: string } }`から`{ params: Promise<{ id: string }> }`に変更
  - `const { id } = await params;`でparamsをawaitしてから使用
  - 対象ファイル: `complete/route.ts`, `[id]/route.ts`

#### UI/UX仕様

**支払い予定リスト**

- pending状態の支払い予定のみ表示
- 期限超過の支払いは赤枠で強調表示
- 各項目に「支払う」ボタンと「削除」ボタンを配置
- カテゴリー名、予定金額、支払期限を表示

**支払い完了ダイアログ**

- 支払い名と予定金額を表示（参考用）
- 実際の支払い金額を入力
- 支払い記録後、紙吹雪アニメーション表示
- 今日の日付でTransactionを作成

---

## 完了内容

支払い予定機能の実装が完了しました。

- ✅ データベーススキーマ追加
- ✅ API実装（作成、一覧取得、完了、削除）
- ✅ UIコンポーネント実装
- ✅ transactionsページへの統合
- ✅ type-check/build成功

---

## 追加実装: 支払い予定登録UI

### 実装内容

支払い予定を登録するUIを追加しました。

**新規ファイル**

- `components/add-scheduled-payment-dialog.tsx` - 支払い予定登録ダイアログ

**変更ファイル**

- `components/scheduled-payments-list.tsx` - 「追加」ボタンを追加
- `app/transactions/page.tsx` - 登録ダイアログの統合

### UI/UX

- 支払い予定リストのヘッダーに「➕ 追加」ボタンを配置
- ボタンをクリックすると登録ダイアログが表示される
- ダイアログ内容：
  - 支払い名（必須）
  - カテゴリー選択（支出カテゴリーのみ）
  - 予定金額（必須）
  - 支払い期限（必須）

### チェック完了

- ✅ type-check成功
- ✅ build成功

---

## 完了内容（最終）

支払い予定機能の実装が**完全に完了**しました。

**実装済み機能**

- ✅ 支払い予定の登録（UI付き）
- ✅ 支払い予定の一覧表示
- ✅ 支払い完了（トランザクション作成）
- ✅ 支払い予定の削除
- ✅ 期限超過の強調表示

## 次回タスク

- ユーザーによる動作確認
- 必要に応じてUI/UX調整

---

## UIデザインガイドライン

### ボタンカラーの統一

プロジェクト全体でsubmitボタンの色を統一するため、CSS変数を使用した一元管理を実装しました。

#### プライマリカラー定義

**定義場所**: `app/globals.css`

```css
@layer base {
  :root {
    --primary: 0 0% 30%; /* ライトモード: グレー（HSL） */
    --primary-foreground: 0 0% 100%; /* ライトモード: ホワイト */
  }

  .dark {
    --primary: 0 0% 70%; /* ダークモード: ライトグレー */
    --primary-foreground: 0 0% 10%; /* ダークモード: ダークグレー */
  }
}
```

**カラーコード**:

- ライトモード背景: `hsl(0 0% 30%)` = `rgb(77, 77, 77)` (グレー)
- ライトモード前景: `hsl(0 0% 100%)` = `rgb(255, 255, 255)` (ホワイト)

#### 使用方法

**推奨**: インラインスタイルを使わず、Tailwindクラスを使用

```tsx
// ✅ 推奨: Tailwindクラスを使用（CSS変数を自動参照）
<Button type="submit">
  登録
</Button>

// ✅ 推奨: カテゴリー選択など、条件付きスタイル
<button
  className={`... ${
    isSelected
      ? "bg-primary text-primary-foreground border-primary"
      : "border-input bg-background"
  }`}
>
  カテゴリー名
</button>

// ❌ 非推奨: インラインスタイル
<Button
  style={{
    backgroundColor: "hsl(0 0% 30%)",
    color: "hsl(0 0% 100%)",
  }}
>
  登録
</Button>
```

#### 修正完了ファイル

インラインスタイルを削除し、CSS変数を使用するように統一:

1. ✅ `app/transactions/page.tsx`
   - 「記録する」ボタン
   - カテゴリー選択ボタン（収入・支出）
2. ✅ `components/scheduled-payments-list.tsx`
   - 「追加」ボタン
   - 「支払う」ボタン
3. ✅ `components/add-scheduled-payment-dialog.tsx`
   - 「登録」ボタン
4. ✅ `components/complete-payment-dialog.tsx`
   - 「支払いを記録」ボタン

#### 利点

- **一元管理**: `globals.css`で色を変更すれば全体に反映
- **ダークモード対応**: 自動的にダークモード用の色に切り替わる
- **保守性向上**: インラインスタイルが散在しないため修正が容易
- **型安全性**: Tailwindの型チェックが効く
