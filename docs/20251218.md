# 2025年12月18日 作業ログ

## セキュリティレビュー実施

### 作業概要
バックエンドAPIおよび認証周りの包括的なセキュリティレビューを実施

### 調査対象
- 認証ロジック: `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/auth.ts`
- Prismaスキーマ: `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/prisma/schema.prisma`
- APIルート:
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/health/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/analytics/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/auth/[...nextauth]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/auth/signup/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/categories/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/categories/[id]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/transactions/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/transactions/[id]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/scheduled-payments/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/scheduled-payments/[id]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/scheduled-payments/[id]/complete/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/dashboard/stacked-area-data/route.ts`

### チェック観点
1. 認証・認可
2. SQLインジェクション対策
3. 入力バリデーション
4. レート制限
5. CORS設定
6. 機密情報の漏洩
7. エラーハンドリング
8. その他の脆弱性

---

## 発見事項

### 🔴 CRITICAL（最重要・最優先対応）

#### 1. レート制限が完全に不在
- **対象**: 全APIエンドポイント
- **リスク**: ブルートフォース攻撃、DoS攻撃、リソース枯渇攻撃、アカウント列挙攻撃
- **修正案**: `@upstash/ratelimit`や`next-rate-limit`の導入
  - 認証系エンドポイント（signup, signin）: 厳しめ（例: 10秒間に5リクエスト）
  - 一般API: 適度（例: 10秒間に50リクエスト）
- **実装例**:
  ```typescript
  import { Ratelimit } from "@upstash/ratelimit";
  import { Redis } from "@upstash/redis";

  const ratelimit = new Ratelimit({
    redis: Redis.fromEnv(),
    limiter: Ratelimit.slidingWindow(10, "10 s"),
  });

  const identifier = request.headers.get("x-forwarded-for") ?? "anonymous";
  const { success } = await ratelimit.limit(identifier);
  if (!success) {
    return NextResponse.json({ error: "Too many requests" }, { status: 429 });
  }
  ```

#### 2. `/api/health`で内部エラーが露出
- **ファイル**: `app/api/health/route.ts:20`
- **問題**:
  ```typescript
  message: error instanceof Error ? error.message : "Unknown error",
  ```
- **リスク**: データベースの詳細情報（ホスト、ポート、スキーマ名など）漏洩
- **修正案**:
  ```typescript
  return NextResponse.json(
    {
      status: "error",
      message: "Database connection failed",
      database: "disconnected",
    },
    { status: 500 }
  );
  ```

---

### 🟠 HIGH（重要・早めに対応）

#### 3. パスワード強度ポリシーが弱い
- **ファイル**:
  - `auth.ts:14-17`
  - `app/api/auth/signup/route.ts:11-14`
- **問題**: 6文字以上のみ。"123456"や"aaaaaa"でもOK
- **リスク**: 弱いパスワードが設定可能、辞書攻撃に脆弱
- **修正案**:
  ```typescript
  password: z
    .string()
    .min(8, { message: "パスワードは8文字以上である必要があります" })
    .max(128, { message: "パスワードは128文字以内である必要があります" })
    .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, {
      message: "パスワードは小文字、大文字、数字を含む必要があります"
    }),
  ```

#### 4. 日付パラメータのバリデーション不足
- **ファイル**:
  - `app/api/analytics/route.ts:26-27`
  - `app/api/transactions/route.ts:61-64`
- **問題**: 日付文字列を直接`new Date()`に渡している
- **リスク**: 無効な日付文字列でDoS攻撃、Invalid Dateによるエラーループ
- **修正案**:
  ```typescript
  const dateSchema = z.string().regex(/^\d{4}-\d{2}-\d{2}$/);

  const startDate = dateSchema.parse(searchParams.get("startDate"));
  const endDate = dateSchema.parse(searchParams.get("endDate"));

  const start = new Date(startDate);
  const end = new Date(endDate);

  if (isNaN(start.getTime()) || isNaN(end.getTime())) {
    return NextResponse.json({ error: "無効な日付です" }, { status: 400 });
  }

  if (start > end) {
    return NextResponse.json({ error: "開始日は終了日より前である必要があります" }, { status: 400 });
  }
  ```

#### 5. 数値パラメータのバリデーション不足
- **ファイル**: `app/api/transactions/route.ts:71-75, 95-96`
- **問題**: `parseFloat`や`parseInt`の結果をバリデーションせずに使用
- **リスク**: NaN攻撃、負の値でoffset指定、巨大な値でlimit指定によるDB負荷増大
- **修正案**:
  ```typescript
  const querySchema = z.object({
    minAmount: z.string().optional().transform((val) => {
      if (!val) return undefined;
      const num = parseFloat(val);
      if (isNaN(num) || num < 0) throw new Error("Invalid minAmount");
      return num;
    }),
    limit: z.string().optional().transform((val) => {
      if (!val) return undefined;
      const num = parseInt(val);
      if (isNaN(num) || num < 1 || num > 1000) throw new Error("Invalid limit");
      return num;
    }),
    offset: z.string().optional().transform((val) => {
      if (!val) return undefined;
      const num = parseInt(val);
      if (isNaN(num) || num < 0) throw new Error("Invalid offset");
      return num;
    }),
  });
  ```

#### 6. ユーザー列挙攻撃が可能
- **ファイル**: `app/api/auth/signup/route.ts:28-32`
- **問題**: メールアドレスが既に存在するかを明示的に返している
- **リスク**: 攻撃者が登録済みメールアドレスを列挙できる
- **修正案**:
  ```typescript
  if (existingUser) {
    // タイミング攻撃防止のため、わざと遅延
    await new Promise(resolve => setTimeout(resolve, 100));
    return NextResponse.json(
      {
        message: "確認メールを送信しました。メールをご確認ください。",
      },
      { status: 200 }
    );
  }
  ```

---

### 🟡 MEDIUM（中程度）

#### 7. console.errorで機密情報が漏洩する可能性
- **対象**: 全APIエンドポイント
- **問題**: エラーオブジェクト全体をログ出力
- **修正案**: エラーメッセージのみを記録
  ```typescript
  console.error("Auth error:", error instanceof Error ? error.message : "Unknown error");
  ```

#### 8. Zodエラーの詳細が外部に露出
- **問題**: `error.issues`をそのまま返している
- **修正案**: 最小限の情報のみを返す
  ```typescript
  if (error instanceof z.ZodError) {
    const userFriendlyErrors = error.issues.map(issue => ({
      field: issue.path.join('.'),
      message: issue.message,
    }));

    return NextResponse.json(
      {
        error: "入力内容に誤りがあります",
        fields: userFriendlyErrors
      },
      { status: 400 }
    );
  }
  ```

#### 9. CORS設定が不明
- **問題**: Next.jsのデフォルト設定に依存
- **修正案**: next.config.tsで明示的に設定
  ```typescript
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: process.env.ALLOWED_ORIGIN || 'https://yourdomain.com' },
          { key: 'Access-Control-Allow-Methods', value: 'GET,POST,PUT,DELETE' },
          { key: 'Access-Control-Allow-Headers', value: 'Content-Type, Authorization' },
        ],
      },
    ];
  }
  ```

#### 10. カテゴリー削除時のカスケード動作が不明確
- **ファイル**: `app/api/categories/[id]/route.ts:92-94`
- **修正案**: 削除前に関連データの存在を確認
  ```typescript
  const relatedTransactions = await prisma.transaction.count({
    where: { categoryId: id },
  });

  if (relatedTransactions > 0) {
    return NextResponse.json(
      {
        error: "このカテゴリーには関連するトランザクションがあります",
        transactionCount: relatedTransactions,
        suggestion: "先にトランザクションを削除するか、別のカテゴリーに移動してください"
      },
      { status: 400 }
    );
  }
  ```

#### 11. セッション有効期限が未設定
- **ファイル**: `auth.ts`
- **修正案**:
  ```typescript
  session: {
    strategy: "jwt",
    maxAge: 30 * 24 * 60 * 60, // 30日
  },
  jwt: {
    maxAge: 30 * 24 * 60 * 60, // 30日
  },
  ```

---

### 🟢 LOW（低優先度）

#### 12. bcrypt saltラウンドが低い
- **ファイル**: `app/api/auth/signup/route.ts:36`
- **問題**: saltラウンド10
- **修正案**: 12以上に変更
  ```typescript
  const hashedPassword = await bcrypt.hash(validatedData.password, 12);
  ```

#### 13. UUIDバリデーションの統一性がない
- **修正案**: すべてのIDフィールドでUUIDバリデーションを統一
  ```typescript
  id: z.string().uuid({ message: "有効なIDを指定してください" }),
  categoryId: z.string().uuid({ message: "有効なカテゴリーIDを指定してください" }),
  ```

---

## ✅ 良好な点

1. すべてのAPIエンドポイントで`auth()`による認証チェックが実施されている
2. IDOR対策が適切（リソースアクセス前に所有権確認）
3. Prismaを使用してSQLインジェクション対策は完璧
4. ほぼすべてのエンドポイントでZodバリデーションが実装されている
5. bcryptでパスワードハッシュ化を適切に実施
6. トランザクション処理が適切に実装されている

---

## 対応優先順位

1. **CRITICAL**: レート制限実装、health API修正
2. **HIGH**: パスワードポリシー強化、日付/数値バリデーション、ユーザー列挙攻撃対策
3. **MEDIUM**: エラーハンドリング改善、CORS設定、セッション有効期限
4. **LOW**: bcrypt saltラウンド、UUIDバリデーション統一

---

## 次のセッションで対応予定

- CRITICALから順番に修正していく予定
- まずはレート制限の実装から開始
