# 2025å¹´12æœˆ18æ—¥ ä½œæ¥­ãƒ­ã‚°

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½

### ä½œæ¥­æ¦‚è¦
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŠã‚ˆã³èªè¨¼å‘¨ã‚Šã®åŒ…æ‹¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½

### èª¿æŸ»å¯¾è±¡
- èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯: `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/auth.ts`
- Prismaã‚¹ã‚­ãƒ¼ãƒ: `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/prisma/schema.prisma`
- APIãƒ«ãƒ¼ãƒˆ:
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/health/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/analytics/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/auth/[...nextauth]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/auth/signup/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/categories/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/categories/[id]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/transactions/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/transactions/[id]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/scheduled-payments/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/scheduled-payments/[id]/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/scheduled-payments/[id]/complete/route.ts`
  - `/Users/masafumikumagai/Documents/github-repos/k-masasa-repos/moneypath/app/api/dashboard/stacked-area-data/route.ts`

### ãƒã‚§ãƒƒã‚¯è¦³ç‚¹
1. èªè¨¼ãƒ»èªå¯
2. SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
3. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
4. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
5. CORSè¨­å®š
6. æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©
7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
8. ãã®ä»–ã®è„†å¼±æ€§

---

## ç™ºè¦‹äº‹é …

### ğŸ”´ CRITICALï¼ˆæœ€é‡è¦ãƒ»æœ€å„ªå…ˆå¯¾å¿œï¼‰

#### 1. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒå®Œå…¨ã«ä¸åœ¨
- **å¯¾è±¡**: å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **ãƒªã‚¹ã‚¯**: ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã€DoSæ”»æ’ƒã€ãƒªã‚½ãƒ¼ã‚¹æ¯æ¸‡æ”»æ’ƒã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ—æŒ™æ”»æ’ƒ
- **ä¿®æ­£æ¡ˆ**: `@upstash/ratelimit`ã‚„`next-rate-limit`ã®å°å…¥
  - èªè¨¼ç³»ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆsignup, signinï¼‰: å³ã—ã‚ï¼ˆä¾‹: 10ç§’é–“ã«5ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
  - ä¸€èˆ¬API: é©åº¦ï¼ˆä¾‹: 10ç§’é–“ã«50ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- **å®Ÿè£…ä¾‹**:
  ```typescript
  import { Ratelimit } from "@upstash/ratelimit";
  import { Redis } from "@upstash/redis";

  const ratelimit = new Ratelimit({
    redis: Redis.fromEnv(),
    limiter: Ratelimit.slidingWindow(10, "10 s"),
  });

  const identifier = request.headers.get("x-forwarded-for") ?? "anonymous";
  const { success } = await ratelimit.limit(identifier);
  if (!success) {
    return NextResponse.json({ error: "Too many requests" }, { status: 429 });
  }
  ```

#### 2. `/api/health`ã§å†…éƒ¨ã‚¨ãƒ©ãƒ¼ãŒéœ²å‡º
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/health/route.ts:20`
- **å•é¡Œ**:
  ```typescript
  message: error instanceof Error ? error.message : "Unknown error",
  ```
- **ãƒªã‚¹ã‚¯**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è©³ç´°æƒ…å ±ï¼ˆãƒ›ã‚¹ãƒˆã€ãƒãƒ¼ãƒˆã€ã‚¹ã‚­ãƒ¼ãƒåãªã©ï¼‰æ¼æ´©
- **ä¿®æ­£æ¡ˆ**:
  ```typescript
  return NextResponse.json(
    {
      status: "error",
      message: "Database connection failed",
      database: "disconnected",
    },
    { status: 500 }
  );
  ```

---

### ğŸŸ  HIGHï¼ˆé‡è¦ãƒ»æ—©ã‚ã«å¯¾å¿œï¼‰

#### 3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒãƒªã‚·ãƒ¼ãŒå¼±ã„
- **ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `auth.ts:14-17`
  - `app/api/auth/signup/route.ts:11-14`
- **å•é¡Œ**: 6æ–‡å­—ä»¥ä¸Šã®ã¿ã€‚"123456"ã‚„"aaaaaa"ã§ã‚‚OK
- **ãƒªã‚¹ã‚¯**: å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šå¯èƒ½ã€è¾æ›¸æ”»æ’ƒã«è„†å¼±
- **ä¿®æ­£æ¡ˆ**:
  ```typescript
  password: z
    .string()
    .min(8, { message: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" })
    .max(128, { message: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯128æ–‡å­—ä»¥å†…ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" })
    .regex(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/, {
      message: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å°æ–‡å­—ã€å¤§æ–‡å­—ã€æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™"
    }),
  ```

#### 4. æ—¥ä»˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¶³
- **ãƒ•ã‚¡ã‚¤ãƒ«**:
  - `app/api/analytics/route.ts:26-27`
  - `app/api/transactions/route.ts:61-64`
- **å•é¡Œ**: æ—¥ä»˜æ–‡å­—åˆ—ã‚’ç›´æ¥`new Date()`ã«æ¸¡ã—ã¦ã„ã‚‹
- **ãƒªã‚¹ã‚¯**: ç„¡åŠ¹ãªæ—¥ä»˜æ–‡å­—åˆ—ã§DoSæ”»æ’ƒã€Invalid Dateã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒ«ãƒ¼ãƒ—
- **ä¿®æ­£æ¡ˆ**:
  ```typescript
  const dateSchema = z.string().regex(/^\d{4}-\d{2}-\d{2}$/);

  const startDate = dateSchema.parse(searchParams.get("startDate"));
  const endDate = dateSchema.parse(searchParams.get("endDate"));

  const start = new Date(startDate);
  const end = new Date(endDate);

  if (isNaN(start.getTime()) || isNaN(end.getTime())) {
    return NextResponse.json({ error: "ç„¡åŠ¹ãªæ—¥ä»˜ã§ã™" }, { status: 400 });
  }

  if (start > end) {
    return NextResponse.json({ error: "é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™" }, { status: 400 });
  }
  ```

#### 5. æ•°å€¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ä¸è¶³
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/transactions/route.ts:71-75, 95-96`
- **å•é¡Œ**: `parseFloat`ã‚„`parseInt`ã®çµæœã‚’ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã›ãšã«ä½¿ç”¨
- **ãƒªã‚¹ã‚¯**: NaNæ”»æ’ƒã€è² ã®å€¤ã§offsetæŒ‡å®šã€å·¨å¤§ãªå€¤ã§limitæŒ‡å®šã«ã‚ˆã‚‹DBè² è·å¢—å¤§
- **ä¿®æ­£æ¡ˆ**:
  ```typescript
  const querySchema = z.object({
    minAmount: z.string().optional().transform((val) => {
      if (!val) return undefined;
      const num = parseFloat(val);
      if (isNaN(num) || num < 0) throw new Error("Invalid minAmount");
      return num;
    }),
    limit: z.string().optional().transform((val) => {
      if (!val) return undefined;
      const num = parseInt(val);
      if (isNaN(num) || num < 1 || num > 1000) throw new Error("Invalid limit");
      return num;
    }),
    offset: z.string().optional().transform((val) => {
      if (!val) return undefined;
      const num = parseInt(val);
      if (isNaN(num) || num < 0) throw new Error("Invalid offset");
      return num;
    }),
  });
  ```

#### 6. ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ—æŒ™æ”»æ’ƒãŒå¯èƒ½
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/auth/signup/route.ts:28-32`
- **å•é¡Œ**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ã‚’æ˜ç¤ºçš„ã«è¿”ã—ã¦ã„ã‚‹
- **ãƒªã‚¹ã‚¯**: æ”»æ’ƒè€…ãŒç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åˆ—æŒ™ã§ãã‚‹
- **ä¿®æ­£æ¡ˆ**:
  ```typescript
  if (existingUser) {
    // ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒé˜²æ­¢ã®ãŸã‚ã€ã‚ã–ã¨é…å»¶
    await new Promise(resolve => setTimeout(resolve, 100));
    return NextResponse.json(
      {
        message: "ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
      },
      { status: 200 }
    );
  }
  ```

---

### ğŸŸ¡ MEDIUMï¼ˆä¸­ç¨‹åº¦ï¼‰

#### 7. console.errorã§æ©Ÿå¯†æƒ…å ±ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§
- **å¯¾è±¡**: å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **å•é¡Œ**: ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’ãƒ­ã‚°å‡ºåŠ›
- **ä¿®æ­£æ¡ˆ**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’è¨˜éŒ²
  ```typescript
  console.error("Auth error:", error instanceof Error ? error.message : "Unknown error");
  ```

#### 8. Zodã‚¨ãƒ©ãƒ¼ã®è©³ç´°ãŒå¤–éƒ¨ã«éœ²å‡º
- **å•é¡Œ**: `error.issues`ã‚’ãã®ã¾ã¾è¿”ã—ã¦ã„ã‚‹
- **ä¿®æ­£æ¡ˆ**: æœ€å°é™ã®æƒ…å ±ã®ã¿ã‚’è¿”ã™
  ```typescript
  if (error instanceof z.ZodError) {
    const userFriendlyErrors = error.issues.map(issue => ({
      field: issue.path.join('.'),
      message: issue.message,
    }));

    return NextResponse.json(
      {
        error: "å…¥åŠ›å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™",
        fields: userFriendlyErrors
      },
      { status: 400 }
    );
  }
  ```

#### 9. CORSè¨­å®šãŒä¸æ˜
- **å•é¡Œ**: Next.jsã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã«ä¾å­˜
- **ä¿®æ­£æ¡ˆ**: next.config.tsã§æ˜ç¤ºçš„ã«è¨­å®š
  ```typescript
  async headers() {
    return [
      {
        source: '/api/:path*',
        headers: [
          { key: 'Access-Control-Allow-Origin', value: process.env.ALLOWED_ORIGIN || 'https://yourdomain.com' },
          { key: 'Access-Control-Allow-Methods', value: 'GET,POST,PUT,DELETE' },
          { key: 'Access-Control-Allow-Headers', value: 'Content-Type, Authorization' },
        ],
      },
    ];
  }
  ```

#### 10. ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤æ™‚ã®ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‹•ä½œãŒä¸æ˜ç¢º
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/categories/[id]/route.ts:92-94`
- **ä¿®æ­£æ¡ˆ**: å‰Šé™¤å‰ã«é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ã‚’ç¢ºèª
  ```typescript
  const relatedTransactions = await prisma.transaction.count({
    where: { categoryId: id },
  });

  if (relatedTransactions > 0) {
    return NextResponse.json(
      {
        error: "ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã¯é–¢é€£ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™",
        transactionCount: relatedTransactions,
        suggestion: "å…ˆã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€åˆ¥ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ç§»å‹•ã—ã¦ãã ã•ã„"
      },
      { status: 400 }
    );
  }
  ```

#### 11. ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ãŒæœªè¨­å®š
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `auth.ts`
- **ä¿®æ­£æ¡ˆ**:
  ```typescript
  session: {
    strategy: "jwt",
    maxAge: 30 * 24 * 60 * 60, // 30æ—¥
  },
  jwt: {
    maxAge: 30 * 24 * 60 * 60, // 30æ—¥
  },
  ```

---

### ğŸŸ¢ LOWï¼ˆä½å„ªå…ˆåº¦ï¼‰

#### 12. bcrypt saltãƒ©ã‚¦ãƒ³ãƒ‰ãŒä½ã„
- **ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/auth/signup/route.ts:36`
- **å•é¡Œ**: saltãƒ©ã‚¦ãƒ³ãƒ‰10
- **ä¿®æ­£æ¡ˆ**: 12ä»¥ä¸Šã«å¤‰æ›´
  ```typescript
  const hashedPassword = await bcrypt.hash(validatedData.password, 12);
  ```

#### 13. UUIDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ±ä¸€æ€§ãŒãªã„
- **ä¿®æ­£æ¡ˆ**: ã™ã¹ã¦ã®IDãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§UUIDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ±ä¸€
  ```typescript
  id: z.string().uuid({ message: "æœ‰åŠ¹ãªIDã‚’æŒ‡å®šã—ã¦ãã ã•ã„" }),
  categoryId: z.string().uuid({ message: "æœ‰åŠ¹ãªã‚«ãƒ†ã‚´ãƒªãƒ¼IDã‚’æŒ‡å®šã—ã¦ãã ã•ã„" }),
  ```

---

## âœ… è‰¯å¥½ãªç‚¹

1. ã™ã¹ã¦ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§`auth()`ã«ã‚ˆã‚‹èªè¨¼ãƒã‚§ãƒƒã‚¯ãŒå®Ÿæ–½ã•ã‚Œã¦ã„ã‚‹
2. IDORå¯¾ç­–ãŒé©åˆ‡ï¼ˆãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹å‰ã«æ‰€æœ‰æ¨©ç¢ºèªï¼‰
3. Prismaã‚’ä½¿ç”¨ã—ã¦SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–ã¯å®Œç’§
4. ã»ã¼ã™ã¹ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§Zodãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
5. bcryptã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ã‚’é©åˆ‡ã«å®Ÿæ–½
6. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ãŒé©åˆ‡ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹

---

## å¯¾å¿œå„ªå…ˆé †ä½

1. **CRITICAL**: ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…ã€health APIä¿®æ­£
2. **HIGH**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼å¼·åŒ–ã€æ—¥ä»˜/æ•°å€¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ—æŒ™æ”»æ’ƒå¯¾ç­–
3. **MEDIUM**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„ã€CORSè¨­å®šã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™
4. **LOW**: bcrypt saltãƒ©ã‚¦ãƒ³ãƒ‰ã€UUIDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµ±ä¸€

---

## æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å¯¾å¿œäºˆå®š

- CRITICALã‹ã‚‰é †ç•ªã«ä¿®æ­£ã—ã¦ã„ãäºˆå®š
- ã¾ãšã¯ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®å®Ÿè£…ã‹ã‚‰é–‹å§‹

---

## å¯¾å¿œå®Œäº†: scheduled-payments APIã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£

### ä¿®æ­£æ—¥æ™‚
2025å¹´12æœˆ18æ—¥ 22:17 (JST)

### ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
1. `app/api/scheduled-payments/route.ts`
2. `app/api/scheduled-payments/[id]/route.ts`
3. `app/api/scheduled-payments/[id]/complete/route.ts`

### ä¿®æ­£å†…å®¹

#### 1. HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®å®šæ•°åŒ–
å…¨ã¦ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’`http-status-codes`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®`StatusCodes`å®šæ•°ã«ç½®ãæ›ãˆ:

- `401` â†’ `StatusCodes.UNAUTHORIZED`
- `400` â†’ `StatusCodes.BAD_REQUEST`
- `404` â†’ `StatusCodes.NOT_FOUND`
- `500` â†’ `StatusCodes.INTERNAL_SERVER_ERROR`
- `201` â†’ `StatusCodes.CREATED`

**ãƒ¡ãƒªãƒƒãƒˆ**:
- ã‚¿ã‚¤ãƒ—ãƒŸã‚¹é˜²æ­¢ï¼ˆIDEã®è£œå®ŒãŒåŠ¹ãï¼‰
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Šï¼ˆ`401`ã‚ˆã‚Š`UNAUTHORIZED`ã®æ–¹ãŒæ„å›³ãŒæ˜ç¢ºï¼‰
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Šï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ãŒå®¹æ˜“ï¼‰

#### 2. console.errorã®å®‰å…¨åŒ–
ä¸Šè¨˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã€ŒğŸŸ¡ MEDIUM - 7. console.errorã§æ©Ÿå¯†æƒ…å ±ãŒæ¼æ´©ã™ã‚‹å¯èƒ½æ€§ã€ã¸ã®å¯¾å¿œ:

**Before**:
```typescript
console.error("Error:", error);
```

**After**:
```typescript
console.error("Error:", error instanceof Error ? error.message : "Unknown error");
```

**åŠ¹æœ**:
- ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã€DBã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã€å†…éƒ¨ãƒ‘ã‚¹ç­‰ã®æ©Ÿå¯†æƒ…å ±ãŒãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ã‚’ä½æ¸›
- æœ¬ç•ªç’°å¢ƒã§ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’è»½æ¸›

### å®Ÿæ–½ã—ãŸå“è³ªãƒã‚§ãƒƒã‚¯
- âœ… `npm run type-check` - PASS
- âœ… `npm run lint` - PASS
- âœ… `npm run build` - PASS

### å‚™è€ƒ
- Prettierã«ã‚ˆã‚‹è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚‚åŒæ™‚ã«é©ç”¨
- ã“ã®ä¿®æ­£ã«ã‚ˆã‚Šã€ä¸Šè¨˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®MEDIUMãƒ¬ãƒ™ãƒ«å¯¾å¿œã®ä¸€éƒ¨ãŒå®Œäº†
- ä»–ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆcategories, transactions, dashboardç­‰ï¼‰ã‚‚åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ—¢ã«ä¿®æ­£æ¸ˆã¿

---

## å¯¾å¿œå®Œäº†: MEDIUMå„ªå…ˆåº¦ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼ˆåŒ…æ‹¬å¯¾å¿œï¼‰

### ä¿®æ­£æ—¥æ™‚
2025å¹´12æœˆ18æ—¥ 23:00 (JST)

### å¯¾å¿œå†…å®¹ã‚µãƒãƒªãƒ¼

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§æŒ‡æ‘˜ã•ã‚ŒãŸMEDIUMå„ªå…ˆåº¦ã®å•é¡Œï¼ˆ7ã€œ11ç•ªï¼‰ã‚’å…¨ã¦å¯¾å¿œå®Œäº†ã€‚

#### 7. âœ… console.errorã§æ©Ÿå¯†æƒ…å ±æ¼æ´©å¯¾ç­–
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: auth.ts + å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ12ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

**ä¿®æ­£å†…å®¹**:
```typescript
// Before
console.error("Error:", error);

// After  
console.error("Error:", error instanceof Error ? error.message : "Unknown error");
```

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§**:
- `auth.ts`
- `app/api/categories/route.ts`
- `app/api/categories/[id]/route.ts`
- `app/api/transactions/route.ts`
- `app/api/transactions/[id]/route.ts`
- `app/api/scheduled-payments/route.ts`
- `app/api/scheduled-payments/[id]/route.ts`
- `app/api/scheduled-payments/[id]/complete/route.ts`
- `app/api/dashboard/stacked-area-data/route.ts`
- `app/api/analytics/route.ts`
- `app/api/auth/signup/route.ts`
- `app/api/health/route.ts`

#### 8. âœ… Zodã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’åˆ¶é™
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆ5ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

**ä¿®æ­£å†…å®¹**:
```typescript
// Before
if (error instanceof z.ZodError) {
  return NextResponse.json(
    { error: "å…¥åŠ›å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™", details: error.issues },
    { status: 400 }
  );
}

// After
if (error instanceof z.ZodError) {
  const fieldErrors = error.issues.map((issue) => ({
    field: issue.path.join("."),
    message: issue.message,
  }));
  return NextResponse.json(
    { error: "å…¥åŠ›å†…å®¹ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™", fields: fieldErrors },
    { status: StatusCodes.BAD_REQUEST }
  );
}
```

**åŠ¹æœ**: å†…éƒ¨æ§‹é€ ã‚’éš è”½ã—ã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ã‚’è¿”ã™ã“ã¨ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã€‚

**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**:
- `app/api/auth/signup/route.ts`
- `app/api/categories/route.ts`
- `app/api/categories/[id]/route.ts`
- `app/api/transactions/route.ts`
- `app/api/transactions/[id]/route.ts`

#### 9. âœ… CORSè¨­å®šã®æ˜ç¤ºçš„ãªè¿½åŠ 
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `next.config.ts`

**ä¿®æ­£å†…å®¹**:
- ç’°å¢ƒå¤‰æ•° `ALLOWED_ORIGIN` ã«ã‚ˆã‚‹æŸ”è»ŸãªCORSåˆ¶å¾¡ã‚’å®Ÿè£…
- `/api/*` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå°‚ç”¨ã®CORSè¨­å®šã‚’è¿½åŠ 
- é–‹ç™ºç’°å¢ƒã§ã¯ä¸è¦ã€æœ¬ç•ªç’°å¢ƒã§å¿…è¦ãªå ´åˆã®ã¿æœ‰åŠ¹åŒ–

**è¨­å®šå†…å®¹**:
```typescript
// ALLOWED_ORIGIN ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æœ‰åŠ¹
{
  source: "/api/:path*",
  headers: [
    { key: "Access-Control-Allow-Origin", value: process.env.ALLOWED_ORIGIN },
    { key: "Access-Control-Allow-Methods", value: "GET, POST, PUT, DELETE, OPTIONS" },
    { key: "Access-Control-Allow-Headers", value: "Content-Type, Authorization" },
    { key: "Access-Control-Max-Age", value: "86400" }, // 24æ™‚é–“
  ]
}
```

#### 10. âœ… ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤æ™‚ã®ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‹•ä½œã‚’æ˜ç¢ºåŒ–
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `app/api/categories/[id]/route.ts`

**ä¿®æ­£å†…å®¹**:
å‰Šé™¤å‰ã«é–¢é€£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å­˜åœ¨ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ã‚ˆã†ã«ä¿®æ­£ã€‚

```typescript
// é–¢é€£ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•°ã‚’ç¢ºèª
const relatedTransactionsCount = await prisma.transaction.count({
  where: { categoryId: id },
});

if (relatedTransactionsCount > 0) {
  return NextResponse.json(
    {
      error: "ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã¯é–¢é€£ã™ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™",
      transactionCount: relatedTransactionsCount,
      suggestion: "å…ˆã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€åˆ¥ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ç§»å‹•ã—ã¦ãã ã•ã„",
    },
    { status: StatusCodes.BAD_REQUEST }
  );
}
```

**åŠ¹æœ**: æ„å›³ã—ãªã„ãƒ‡ãƒ¼ã‚¿æå¤±ã‚’é˜²æ­¢ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã‚’æä¾›ã€‚

#### 11. âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹æœŸé™ã®è¨­å®š
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `auth.ts`

**ä¿®æ­£å†…å®¹**:
```typescript
session: {
  strategy: "jwt",
  maxAge: 30 * 24 * 60 * 60, // 30æ—¥
  updateAge: 24 * 60 * 60, // 24æ™‚é–“ã”ã¨ã«æ›´æ–°
},
jwt: {
  maxAge: 30 * 24 * 60 * 60, // 30æ—¥
},
```

**åŠ¹æœ**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’æ˜ç¤ºçš„ã«è¨­å®šã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨UXã®ãƒãƒ©ãƒ³ã‚¹ã‚’å®Ÿç¾ã€‚

---

## è¿½åŠ å¯¾å¿œ: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®å®šæ•°åŒ–

å…¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ `http-status-codes` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® `StatusCodes` å®šæ•°ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«çµ±ä¸€ã€‚

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸**:
```bash
npm install http-status-codes
```

**ç½®ãæ›ãˆä¾‹**:
- `401` â†’ `StatusCodes.UNAUTHORIZED`
- `400` â†’ `StatusCodes.BAD_REQUEST`
- `404` â†’ `StatusCodes.NOT_FOUND`
- `403` â†’ `StatusCodes.FORBIDDEN`
- `500` â†’ `StatusCodes.INTERNAL_SERVER_ERROR`
- `201` â†’ `StatusCodes.CREATED`

**åŠ¹æœ**:
- ã‚¿ã‚¤ãƒ—ã‚»ãƒ¼ãƒ•æ€§å‘ä¸Šï¼ˆIDEã®è£œå®ŒãŒåŠ¹ãï¼‰
- å¯èª­æ€§å‘ä¸Šï¼ˆæ•°å­—ã‚ˆã‚Šæ„å‘³ãŒæ˜ç¢ºï¼‰
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§å‘ä¸Š

---

## æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§å¯¾å¿œäºˆå®š

### ğŸ”µ LOWå„ªå…ˆåº¦ï¼ˆä½™è£•ãŒã‚ã‚Œã°å¯¾å¿œï¼‰

12. **bcrypt saltãƒ©ã‚¦ãƒ³ãƒ‰ã®å¼·åŒ–**
   - ç¾åœ¨: saltãƒ©ã‚¦ãƒ³ãƒ‰10
   - æ¨å¥¨: saltãƒ©ã‚¦ãƒ³ãƒ‰12ä»¥ä¸Š

13. **UUIDãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®çµ±ä¸€**
   - å…¨ã¦ã®IDãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ `.uuid()` ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ±ä¸€

---

## å®Ÿæ–½æ¸ˆã¿å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆæœ€çµ‚ç¢ºèªã¯æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

- â³ `npm run type-check` - å®Ÿè¡Œäºˆå®š
- â³ `npm run lint` - å®Ÿè¡Œäºˆå®š
- â³ `npm run build` - å®Ÿè¡Œäºˆå®šï¼ˆCLAUDE.mdã«è¨˜è¼‰ï¼‰

