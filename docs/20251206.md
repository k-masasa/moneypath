# 2025/12/06 作業記録

## テーマ切り替え機能の実装

### 概要
ユーザーからの要望で、ダークモード・ライトモード・システム設定に従うモードを切り替えられる設定ページを実装。

### 技術選定
- **localStorage管理（next-themesを使用）** を採用
  - 理由: DBに保存する方法もあるが、テーマ設定はUIの個人設定であり、localStorage管理の方が適切
  - メリット: サーバーリクエスト不要、高速、シンプル
  - next-themesライブラリを使用してハイドレーションエラーを防止

### 実装内容

#### 1. next-themesパッケージのインストール
```bash
npm install next-themes
```

#### 2. ThemeProviderコンポーネントの作成
**ファイル**: `components/theme-provider.tsx`
```typescript
"use client";

import { ThemeProvider as NextThemesProvider } from "next-themes";
import type { ThemeProviderProps } from "next-themes";

export function ThemeProvider({ children, ...props }: ThemeProviderProps) {
  return <NextThemesProvider {...props}>{children}</NextThemesProvider>;
}
```

**修正ポイント**:
- 最初、型のインポートを`next-themes/dist/types`から行おうとしてエラー
- `next-themes`から直接インポートするように修正

#### 3. app/layout.tsxへのThemeProvider追加
**ファイル**: `app/layout.tsx`
```typescript
<html lang="ja" suppressHydrationWarning>
  <body className="antialiased">
    <ThemeProvider
      attribute="class"
      defaultTheme="system"
      enableSystem
      disableTransitionOnChange
    >
      <SessionProvider>
        <LoadingProvider>
          <TransactionDialogProvider>
            {children}
            <Toaster />
          </TransactionDialogProvider>
        </LoadingProvider>
      </SessionProvider>
    </ThemeProvider>
  </body>
</html>
```

**重要**: `suppressHydrationWarning`を`<html>`タグに追加してハイドレーションエラーを防止

#### 4. 設定ページの作成
**ファイル**: `app/settings/page.tsx`

**実装内容**:
- `useTheme()`フックでテーマ管理
- `mounted`ステートでクライアントサイドレンダリングを確保（ハイドレーションエラー防止）
- 3つのテーマオプション:
  - ライトモード（Sun アイコン）
  - ダークモード（Moon アイコン）
  - システム設定に従う（Monitor アイコン）
- 選択中のオプションには視覚的なインジケーター表示

**ハイドレーション対策**:
```typescript
const [mounted, setMounted] = useState(false);

useEffect(() => {
  setMounted(true);
}, []);

if (!mounted) {
  return <div>読み込み中...</div>;
}
```

#### 5. サイドバーに設定メニューを追加
**ファイル**: `components/dashboard-sidebar.tsx`

**変更内容**:
- `Settings`アイコンをインポート
- `menuItems`配列に設定項目を追加:
```typescript
{
  href: "/settings",
  label: "設定",
  icon: Settings,
}
```

#### 6. Tailwind CSSの確認
- `tailwind.config.ts`: 既に`darkMode: "class"`が設定済み
- `app/globals.css`: 既に`:root`と`.dark`のCSS変数定義済み

### 検証実施項目

#### 型チェック
```bash
npm run type-check
```
**結果**: ✅ エラーなし

#### ビルドチェック
```bash
npm run build
```
**結果**: ✅ 正常にビルド完了

#### Docker再起動
```bash
docker compose -f docker-compose.dev.yml restart app
```
**結果**: ✅ 正常に起動完了（Ready in 1689ms）

### エラー対応履歴

#### エラー1: 型定義のインポートエラー
**エラー内容**:
```
Cannot find module 'next-themes/dist/types' or its corresponding type declarations.
```

**原因**: 型のインポートパスが間違っていた

**修正内容**:
```typescript
// 修正前
import { type ThemeProviderProps } from "next-themes/dist/types";

// 修正後
import type { ThemeProviderProps } from "next-themes";
```

### 残タスク
- [x] next-themesパッケージインストール
- [x] ThemeProviderコンポーネント作成
- [x] app/layout.tsxにThemeProvider追加
- [x] 設定ページ作成
- [x] サイドバーに設定メニュー追加
- [x] type-checkとbuild実行
- [x] Docker再起動
- [x] ハードコードされた色の修正
- [ ] ブラウザでテーマ切り替え動作確認（ユーザー確認待ち）

## ライトモードデザイン崩れの修正

### 問題
テーマ切り替え機能実装後、ライトモードのデザインが崩れる問題が発生：
- サイドバーのホバー色が変
- カテゴリー管理ページのチェックボックス枠線が変
- 全体的に文字が見えにくい

### 原因
以下のファイルでTailwind CSSのハードコードされた色（`bg-gray-*`, `text-gray-*`, `border-gray-*`）を使用していたため、ダークモード対応の変数ベースのクラスに置き換えが必要だった。

### 修正内容

#### 1. components/dashboard-sidebar.tsx
**修正箇所1: サイドバーメニューのホバー色**
```typescript
// 修正前
className={`... ${isActive ? "" : "hover:bg-gray-100"}`}

// 修正後
className={`... ${isActive ? "" : "hover:bg-accent"}`}
```

**修正箇所2: ログアウトボタンのホバー色**
```typescript
// 修正前
className="... hover:bg-red-50"

// 修正後
className="... hover:bg-destructive/10"
```

#### 2. app/categories/page.tsx
**修正箇所: 公的負担チェックボックスの枠線色**
```typescript
// 修正前
className="h-4 w-4 rounded border-gray-300"

// 修正後
className="h-4 w-4 rounded border-input"
```

#### 3. components/edit-category-dialog.tsx
**修正箇所: 公的負担チェックボックスの枠線色**
```typescript
// 修正前
className="h-4 w-4 rounded border-gray-300"

// 修正後
className="h-4 w-4 rounded border-input"
```

### 修正後の検証

#### 型チェック
```bash
npm run type-check
```
**結果**: ✅ エラーなし

#### ビルドチェック
```bash
npm run build
```
**結果**: ✅ 正常にビルド完了

#### Docker再起動
```bash
docker compose -f docker-compose.dev.yml restart app
```
**結果**: ✅ 正常に起動完了（Ready in 1627ms）

### メモ
- テーマ切り替えはlocalStorageで管理されるため、ブラウザごとに設定が保持される
- ハイドレーションエラー防止のため、`mounted`ステートチェックが重要
- システム設定に従うモードでは、OSのダーク/ライトモード設定が自動反映される

### 次回セッションへの引き継ぎ事項
- ブラウザでの実際の動作確認が必要
- 3つのテーマモード（light/dark/system）の切り替えが正常に動作するか確認
- ダークモードでの各ページの表示確認（特にダッシュボード、収支管理、カテゴリー管理）

---

## テーマ切り替え機能削除 & 完全ダークモード化

### 背景
テーマ切り替え機能の実装中、以下の問題が発生：
1. ダイアログが透明になる（収支登録ダイアログなど）
2. Tailwind v4の`@theme`ディレクティブとnext-themesの`.dark`クラスが競合
3. ライトモードのデザインを維持しつつダークモード対応するのが困難

### 決定事項
**テーマ切り替え機能を削除し、最初から完全ダークモードのデザインにする**

### 実装内容

#### 1. テーマ切り替え関連の削除
```bash
# next-themesパッケージのアンインストール
npm uninstall next-themes

# 削除したファイル
rm -rf app/settings/
rm components/theme-provider.tsx
```

#### 2. サイドバーから設定メニューを削除
**ファイル**: `components/dashboard-sidebar.tsx`
- `Settings`アイコンのインポートを削除
- `menuItems`から設定項目を削除

#### 3. layout.tsxを元に戻す
**ファイル**: `app/layout.tsx`
```typescript
// ThemeProviderを削除
// suppressHydrationWarningを削除
<html lang="ja">
  <body className="antialiased">
    <SessionProvider>
      <LoadingProvider>
        <TransactionDialogProvider>
          {children}
          <Toaster />
        </TransactionDialogProvider>
      </LoadingProvider>
    </SessionProvider>
  </body>
</html>
```

#### 4. globals.cssをダークモードに変更
**ファイル**: `app/globals.css`

**変更内容**:
- `@theme`ディレクティブを復活させ、ダークモードの色を設定
- `:root`の色もダークモードに変更

```css
@theme {
  /* Dark mode colors as default */
  --color-background: oklch(0.15 0 0);
  --color-foreground: oklch(0.95 0 0);
  --color-primary: oklch(0.5 0.15 145);
  --color-card: oklch(0.18 0 0);
  --color-card-foreground: oklch(0.95 0 0);
  // ... 他のダークモード色
}

:root {
  /* Dark mode colors */
  --background: 0 0% 15%;
  --foreground: 0 0% 95%;
  --card: 0 0% 18%;
  --card-foreground: 0 0% 95%;
  // ... 他のダークモード色
}
```

#### 5. ハードコードされた色の修正

**5-1. ヘッダーの背景色**
**ファイル**: `components/dashboard-header.tsx`
```typescript
// 修正前
<header className="..." style={{ backgroundColor: '#f6f8fa' }}>
  <Link href="/dashboard" className="text-2xl font-bold">

// 修正後
<header className="... bg-card">
  <Link href="/dashboard" className="text-2xl font-bold text-foreground">
```

**5-2. 円グラフのラベルと線**
**ファイル**: `components/dashboard-client.tsx`
```typescript
// 修正前（ラベル線）
<line ... stroke="#000" strokeWidth={1} />

// 修正後
<line ... stroke="hsl(var(--foreground))" strokeWidth={1} />

// 修正前（ラベルテキスト）
<text ... fill="#000" fontSize={14} ...>

// 修正後
<text ... fill="hsl(var(--foreground))" fontSize={14} ...>
```

**5-3. 折れ線グラフのツールチップ**
**ファイル**: `components/dashboard-client.tsx`
```typescript
// 修正前
contentStyle={{
  backgroundColor: '#fff',
  border: '1px solid #e0e0e0',
  borderRadius: '4px',
}}

// 修正後
contentStyle={{
  backgroundColor: 'hsl(var(--card))',
  border: '1px solid hsl(var(--border))',
  borderRadius: '4px',
  color: 'hsl(var(--card-foreground))',
}}
```

### 検証結果
- ✅ type-check: エラーなし
- ✅ build: 成功
- ✅ Docker起動: 正常

### ダークモードの色設定
- 背景色: `oklch(0.15 0 0)` (15%の明るさ、かなり暗い)
- カード背景: `oklch(0.18 0 0)` (18%の明るさ、背景より少し明るい)
- テキスト: `oklch(0.95 0 0)` (95%の明るさ、ほぼ白)
- プライマリ色: `oklch(0.5 0.15 145)` (緑系、元のまま)
- ボーダー・入力欄: `oklch(0.25 0 0)` (25%の明るさ)

---

## 最終的な配色：モダンなライトモード

### 背景
ダークモードの調整を何度も繰り返した結果、ユーザーから「明るい系の色にしたい」という要望があり、最終的にモダンなライトモードに変更。

### 最終的な配色
**ファイル**: `app/globals.css`

```css
/* モダンなライトモード配色 */
--color-background: oklch(0.98 0 0);  /* ほんのりグレーの背景 */
--color-foreground: oklch(0.2 0 0);   /* 濃いグレーのテキスト */
--color-card: oklch(1 0 0);           /* 真っ白のカード */
--color-border: oklch(0.90 0 0);      /* 薄いグレーのボーダー */
--color-input: oklch(0.96 0 0);       /* 非常に薄いグレーの入力欄 */
```

### コンセプト
- GitHub、Notion、Linearなどのモダンなサービスの配色を参考
- 背景は真っ白ではなく、ほんのりグレー（目に優しい）
- カードは真っ白で浮き上がる感じ
- テキストは真っ黒ではなく濃いグレー（読みやすい）

### 結果
✅ ユーザーから「改善された」とのフィードバック

---

## 本番環境デプロイ検討

### 背景
本番環境とdev環境を分離したいという要望。Docker コンテナを本番環境でも使用したい。

### 検討した選択肢
1. **Railway** - 月$5〜20、簡単、スリープなし
2. **Render無料プラン** - 完全無料、スリープあり
3. **AWS EC2 + Docker Compose** - 1年目無料、2年目月4,200円、学習価値高い
4. **AWS ECS Fargate** - 月9,000円、高すぎる

### 最終的な選択肢（2択）
1. **Render無料プラン** - 完全無料、30分でリリース、スリープあり
2. **AWS EC2 + Docker Compose** - 1年目無料、AWSスキル習得

### 作成したドキュメント
- `docs/deployment-options.md` - デプロイ選択肢の概要
- `docs/render-deployment-guide.md` - Render無料プランの詳細手順書

### 決定事項
- **AWS EC2 + Docker Compose** を選択
- 理由: AWSの実践的なスキル習得、1年目無料

### 作成したドキュメント（追加）
- `docs/aws-ec2-deployment-guide.md` - AWS EC2デプロイの詳細手順書

### AWS EC2デプロイ手順書の内容
**推定セットアップ時間**: 2〜3時間（初回）

**手順の概要**:
1. ステップ1: AWSアカウントのセットアップ（10分）
2. ステップ2: EC2インスタンスの起動（20分）
3. ステップ3: EC2インスタンスの初期セットアップ（30分）
   - Docker、Docker Compose、Gitのインストール
4. ステップ4: アプリケーションのデプロイ（60分）
   - 本番用docker-compose.yml作成
   - 本番用Dockerfile作成
   - 環境変数設定
   - ビルド＆起動
5. ステップ5: 動作確認（10分）
6. ステップ6: 本番運用設定（30分）
   - SSL証明書設定（Let's Encrypt）
   - 自動起動設定
   - バックアップ設定
   - モニタリング設定

**重要なポイント**:
- EC2インスタンスタイプ: **t2.micro**（無料枠対象）
- Elastic IP: インスタンス関連付け中は無料、未使用時は課金
- MySQLをそのまま使用可能（PostgreSQL移行不要）
- Google OAuth設定でElastic IPをリダイレクトURIに登録必要
- セキュリティグループでポート3000を開放
- SSL化にはドメイン名が必要（Let's Encryptを使用）

**コスト概要**:
- 1年目: ほぼ無料（AWS無料枠）
- 2年目以降: 約3,500〜4,200円/月

### 最終決定
- **AWS EC2 + Docker Compose** で本番デプロイすることに決定
- 理由: EC2でもDockerが使えること、MySQLをそのまま使えること、コストがECSの半額

### ドキュメント整理
- `docs/render-deployment-guide.md` を削除（Render使わないため）
- `docs/deployment-options.md` をEC2のみの内容に更新
  - よくある質問（FAQ）追加
  - 構成図追加
  - コスト詳細追加

### 次のステップ
- AWS EC2デプロイ手順書（`docs/aws-ec2-deployment-guide.md`）に従ってデプロイ実施
- ドメイン名を取得してSSL化を検討（オプション）
