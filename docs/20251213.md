# 2025年12月13日 作業ログ

## 作業概要

ESLint + Prettier のセットアップを実施。Next.js 16 と ESLint 9 の互換性問題により試行錯誤したが、最終的に TypeScript ESLint のみの構成で動作確認完了。

## 実施内容

### 1. ESLint + Prettier セットアップ試行

**目標:**
- ESLint のルール定義
- VSCode で保存時に自動整形
- 自動整形コマンドの用意
- GitHub Actions で整形チェック実行

**初期アプローチ:**
- Prettier と関連パッケージをインストール
- `.prettierrc`, `.prettierignore` を作成
- VSCode 設定 (`.vscode/settings.json`) を作成
- package.json に `format`, `format:check`, `lint:fix` スクリプトを追加
- GitHub Actions ワークフロー (`.github/workflows/lint-format.yml`) を作成

### 2. 互換性問題との遭遇

**問題:**
- Next.js 16 の `eslint-config-next@16.0.1` が ESLint 9 を要求
- ESLint 9 は flat config 形式 (`eslint.config.mjs`) が必須
- しかし `eslint-config-next` が flat config 形式に完全対応しておらず循環参照エラー発生

**試行錯誤:**
1. **Flat config 形式への移行を試みる** → 循環参照エラー
2. **ESLint 8 へダウングレード** → `eslint-config-next` との peer dependency エラー
3. **`--legacy-peer-deps` でゴリ押し** → インストールはできるが不安定

### 3. 最終的な解決策

**選択した方針:**
- Next.js 固有の ESLint ルールは諦める
- TypeScript ESLint + Prettier の構成にする
- ESLint 9 と flat config 形式を採用

**実装:**

#### インストールしたパッケージ
```bash
npm install --save-dev \
  eslint@^9.39.1 \
  typescript-eslint@^8.49.0 \
  @typescript-eslint/parser@^8.49.0 \
  @typescript-eslint/eslint-plugin@^8.49.0 \
  prettier@^3.7.4 \
  eslint-config-prettier@^10.1.8 \
  eslint-plugin-prettier@^5.5.4 \
  --legacy-peer-deps
```

#### 削除したパッケージ
```bash
npm uninstall eslint-config-next @eslint/eslintrc
```

#### 作成した設定ファイル

**eslint.config.mjs** (ESLint 9 flat config 形式)
```javascript
import eslint from "@eslint/js";
import tseslint from "typescript-eslint";
import prettier from "eslint-plugin-prettier/recommended";

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  prettier,
  {
    languageOptions: {
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
    rules: {
      "prettier/prettier": "warn",
      "@typescript-eslint/no-unused-vars": [
        "warn",
        {
          argsIgnorePattern: "^_",
          varsIgnorePattern: "^_",
        },
      ],
      "@typescript-eslint/no-explicit-any": "warn",
    },
  },
  {
    ignores: [
      "node_modules/**",
      ".next/**",
      "out/**",
      "dist/**",
      "build/**",
      "coverage/**",
      "*.config.js",
      "*.config.mjs",
      "*.config.ts",
    ],
  }
);
```

**.prettierrc**
```json
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": false,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "arrowParens": "always",
  "endOfLine": "lf"
}
```

**.prettierignore**
```
node_modules/
.next/
out/
dist/
build/
coverage/
*.env
*.env.local
*.env.production
package-lock.json
yarn.lock
pnpm-lock.yaml
prisma/migrations/
```

**.vscode/settings.json**
```json
{
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": "explicit"
  },
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[javascript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[javascriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[json]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "eslint.validate": [
    "javascript",
    "javascriptreact",
    "typescript",
    "typescriptreact"
  ]
}
```

#### package.json スクリプト修正
```json
{
  "scripts": {
    "lint": "eslint .",
    "lint:fix": "eslint . --fix",
    "format": "prettier --write \"**/*.{js,jsx,ts,tsx,json,css,md}\"",
    "format:check": "prettier --check \"**/*.{js,jsx,ts,tsx,json,css,md}\"",
    "type-check": "tsc --noEmit"
  }
}
```

#### GitHub Actions ワークフロー更新
`.github/workflows/lint-format.yml` に `--legacy-peer-deps` フラグを追加:
```yaml
- name: Install dependencies
  run: npm ci --legacy-peer-deps
```

### 4. 動作確認結果

#### ✅ npm run format:check
```bash
$ npm run format:check
Checking formatting...
All matched files use Prettier code style!
```
→ 全ファイルがフォーマット済み

#### ✅ npm run lint
```bash
$ npm run lint
✖ 157 problems (131 errors, 26 warnings)
```
→ ESLint が正常に動作し、型安全性の問題を検出

主なエラー内容:
- `@typescript-eslint/no-unsafe-assignment`: any 型の安全でない代入
- `@typescript-eslint/no-misused-promises`: Promise の誤用
- `@typescript-eslint/no-floating-promises`: await されていない Promise
- `@typescript-eslint/no-unused-vars`: 未使用変数

#### ✅ npm run lint:fix
→ 実行成功（自動修正可能なものは修正済み）

#### ✅ npm run type-check
→ TypeScript の型チェックは正常動作

#### ✅ Docker コンテナ再起動
```bash
$ docker compose -f docker-compose.dev.yml restart app
✓ Ready in 1822ms
```
→ 正常起動確認

## Next.js 固有ルールを諦めた理由

**Next.js 固有の ESLint ルールの例:**
- `next/no-html-link-for-pages`: `<a>` タグの代わりに `<Link>` を使う
- `next/no-img-element`: `<img>` の代わりに最適化された `<Image>` を使う
- `next/no-head-import-in-document`: Document で誤った Head をインポートしない

**判断:**
- これらのルールは「あったら便利」程度
- TypeScript + Prettier で基本的な品質は保証できる
- Next.js 16 + ESLint 9 の互換性問題により、無理に使うよりシンプルな構成の方が安定

## 利用可能なコマンド

| コマンド | 説明 |
|---------|------|
| `npm run lint` | ESLint でコード品質チェック |
| `npm run lint:fix` | ESLint で自動修正可能な問題を修正 |
| `npm run format` | Prettier で全ファイルをフォーマット |
| `npm run format:check` | Prettier でフォーマットをチェック（CI 用） |
| `npm run type-check` | TypeScript の型チェック |

## GitHub Actions

`.github/workflows/lint-format.yml` で以下を自動実行:
1. Prettier フォーマットチェック (`npm run format:check`)
2. ESLint チェック (`npm run lint`)
3. TypeScript 型チェック (`npm run type-check`)

トリガー:
- `main` または `develop` ブランチへの push
- `main` または `develop` ブランチへの Pull Request

## 今後の課題

1. **ESLint エラーの修正**
   - 現在 157 個の問題（131 エラー、26 警告）が検出されている
   - 型安全性の問題（any 型の使用、Promise の適切な処理など）を修正する必要あり

2. **Next.js 固有ルールの再導入検討**
   - Next.js 16 が ESLint 9 と flat config に完全対応したら再検討
   - または Next.js のアップデートを待つ

3. **コード品質の向上**
   - any 型の使用を減らす
   - Promise の適切な処理（await, .catch, .then）
   - 未使用変数の削除

## 参考情報

- [ESLint 9 Migration Guide](https://eslint.org/docs/latest/use/configure/migration-guide)
- [TypeScript ESLint](https://typescript-eslint.io/)
- [Next.js ESLint Configuration](https://nextjs.org/docs/app/api-reference/config/eslint)
- [Prettier Configuration](https://prettier.io/docs/en/configuration.html)
